---
title: "LMTP_TargetedLearning"
output: html_document
---

```{r}
devtools::load_all(".")

# ---- Setup ----
set.seed(2025)
library(simcausal)
library(TargetedLearning)
library(dplyr)

# simulate data under natural progression of events
n <- 40
ds <- simulate_lmtp_data_under_counterfactual_policy(
  n = n, 
  policy_seq = NULL,
  sd_for_noise = 10)

# structure it in the LMTP Data Structure
ds <- LMTP_Data_Struct$new(
  data = ds,
  id_col     = "id",
  n_timesteps = 3,
  A_cols     = c("A1", "A2", "A3"),
  L_cols     = list(c("L11", "L12"),
                    c("L21", "L22"),
                    c("L31", "L32")),
  W_cols     = c("W1", "V"),
  Y_col      = "Y")

# define a sequence of policies that reduce exposure by -.05 
shift_mtp <- mtp_additive_shift(delta = -.05)
policy_seq <- repeat_policy_over_time(shift_mtp, 3)


# here we show two feasible approaches for specifying 
# the nuisance models g: 
# 
# either using density learners, like lnr_lm_density 
# 
# or using the ratio classification trick for density estimation.


# nuis1 uses density estimators
nuis1 <- LMTPNuisanceFactory$new(
  # learners_Q = list(nadir::lnr_lm, nadir::lnr_rf, nadir::lnr_xgboost),
  learners_g = nadir::lnr_lm_density,
  policy_seq = policy_seq,
  A_type = "continuous",
  repeat_fmls_lnrs_args = TRUE,
  g_mode = 'density'
)

# nuis2 uses the ratio classification trick:
# 
# if using the ratio classification trick, then make sure to use 
# nadir::lnr_logistic or similarwith g_mode = 'ratio_classification'
# simpler  models
nuis2 <- LMTPNuisanceFactory$new(
  # learners_Q = list(nadir::lnr_lm, nadir::lnr_rf, nadir::lnr_xgboost),
  # learners_g = nadir::lnr_lm_density,
  learners_g = list(nadir::lnr_logistic, nadir::lnr_rf_binary),
  policy_seq = policy_seq,
  A_type = "continuous",
  repeat_fmls_lnrs_args = TRUE,
  g_mode = 'ratio_classification'
) 
options(future.globals.maxSize = Inf) # if using lnr_rf_binary



fit_intv <- fit_tmle_for_LMTP(
  ds,
  policy_seq = policy_seq,
  learners_Q = nadir::lnr_lm,
  learners_g_factory = nuis2,
  outcome_link = 'identity',
  repeat_lnrs = TRUE,
  method = 'tmle')


fit_intv$psi; fit_intv$ci95
fit_intv$se


# define the identity MTP and a sequence of identity MTPs
identity_mtp <- mtp_additive_shift(delta = 0)
policy_seq_identity <- repeat_policy_over_time(identity_mtp, 3)

# simpler  models
nuis2 <- LMTPNuisanceFactory$new(
  # learners_Q = list(nadir::lnr_lm, nadir::lnr_rf, nadir::lnr_xgboost),
  learners_g = nadir::lnr_lm_density,
  policy_seq = policy_seq_identity,
  A_type = "continuous",
  repeat_fmls_lnrs_args = TRUE
)


fit_natural <- fit_tmle_for_LMTP(
  ds,
  policy_seq = policy_seq_identity,
  learners_Q = nadir::lnr_lm,
  learners_g_factory = nuis2,
  outcome_link = 'identity',
  repeat_lnrs = TRUE)


fit_natural$psi; fit_natural$ci95
fit_natural$se
```


If we want to report on the LMTP difference estimate, 
$\mathbb{E}[Y^d - Y]$, we can report on that as follows
implicitly using the functional delta method to justify inference
via the differenced EIFs.
```{r}
psi <- fit_intv$psi - fit_natural$psi 
se <- sqrt(var(fit_intv$ic - fit_natural$ic)/n)

ci <- c( psi + qnorm(0.025) * se, psi + qnorm(0.975) * se)
psi
ci
```


