---
title: "Simulation of LMTPs"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(lmtpi)
library(tidyverse)

```

## Scenario 1: Simple Net-Benefit Effect, No Time-Varying Confounder/Exposure Feedback

Let's imagine as simple a scenario we can: 

  * There is a drug we are studying for its effect on some disease state 
  * People's adherence to the drug daily is $\mathrm{Bernoulli}(\lambda)$ on each day
  and each time-step represents a week, so we 
  * There are time-varying covariates $L_{i,t}$ representing disease state, but 
  that's it.  We will assume if they take their drug, that reduces their disease state. 
  Everyone in the study starts out with a fairly high disease state. 
  
```{r}
# hyperparameters for study 
lambda <- 0.7
n_timesteps <- 5L
n_individuals <- 40L

# generate some data
dgp_simple_scenario <- function(n, t) {
  df <- list()
  
  stopifnot(is.integer(t))
  
  for (i in 1:t) {
    if (i == 1) {
      newdata <- 
        tibble::tibble(
          id = 1:n,
          t = 1,
          L = rnorm(n = n, mean = 40, sd = 5),
          A = rbinom(n = n, size = 7, prob = lambda)
        )
    } else if (i > 1) {
      last_timestep <- 
        df |> filter(t == i - 1)
      
      newdata <- 
        last_timestep |> 
        mutate(
          t = i,
          L = L - rnorm(n = 40, mean = 4, sd = 1)*ifelse(A>3, 1, 0) + rnorm(n = 40, mean = 1, sd = 1)*ifelse(A <= 3, 1, 0),
          A = rbinom(n = n, size = 7, prob = lambda)
        )
    }
    df <- dplyr::bind_rows(df, newdata)
  }
  return(df)
}

df <- dgp_simple_scenario(n = n_individuals, t = n_timesteps)

ggplot(df, aes(x = t, y = L, group = id, color = A)) + 
  geom_point() + 
  geom_line(alpha = 0.5, size = 1) + 
  colorspace::scale_color_continuous_sequential(palette = "Plasma") + 
  theme_bw() + 
  labs(
    x = "Time",
    y = "Disease State",
    color = "Doses Taken",
    shape = "Doses Taken",
    title = "Patient History in Simulation Study",
    subtitle = paste0("n = ", n_individuals, ", ", n_timesteps, " time-steps")) + 
  theme(legend.position = 'bottom',
        panel.grid = element_blank()) 
```

Imagine that we could get everyone to improve their adherence to the prescribed 
regimen by *up to 2 days* by some kind of encouragement design. 
Obviously that wouldn't encourage people to take the drug more than 
they're supposed to (once every day of the week).

We'd like to know how much of an impact this might have on their outcomes. 

```{r}
mtp <- MTP$new(
  smooth_invertible_regions = list(
    function(A, L) { if (A %btn[]% c(0, 5)) TRUE else FALSE },
    function(A, L) { if (A == 6) TRUE else FALSE },
    function(A, L) { if (A == 7) TRUE else FALSE }),
  policy = list(
    \(A, L) { A + 2 },
    \(A, L) { A + 1 },
    \(A, L) { A }
  ),
  inverse_policy = list(
    \(A, L) { A - 2 },
    \(A, L) { A - 1 },
    \(A, L) { A }
  ),
  derivative_of_policy = list(
    \(A, L) 1,
    \(A, L) 1,
    \(A, L) 1
  )
)




lmtp_double_robust_estimator <- function(data, mtp, time, ...) {
  
  # fitting treatment models 
}
```
